import{g as ce,u as me,a as ue,r as i,j as e,L as xe}from"./index-BWRs-o60.js";import{s as _}from"./sos.service-z5TfIbel.js";import{g as F,c as he,A as ge}from"./AuroraMap-C9vENJKY.js";import{E as fe}from"./EventTimeline-3C_ACpxt.js";import{R as be,L as pe,C as je,X as ye,Y as Ne,T as ve,a as R}from"./LineChart-CdzHRI3k.js";import"./createLucideIcon-C8xEK6Q3.js";import"./clsx-B-dksMZM.js";function Ee(){var q,H,J,Q,Z,ee,se,te,re,ae;const{id:d}=ce(),oe=me(),{user:l}=ue(),[s,j]=i.useState(null),[ne,de]=i.useState(!0),[x,ie]=i.useState([]),[I,M]=i.useState(!1),[T,U]=i.useState([]),[D]=i.useState(!1),C=Array.isArray(s==null?void 0:s.attachments)?s.attachments:[],[A,O]=i.useState(!1),[z,g]=i.useState(null),[f,L]=i.useState(!1),[b,B]=i.useState(!1),[y,K]=i.useState(void 0),[$,N]=i.useState([]),[E,P]=i.useState(""),W=i.useRef(null),h=i.useCallback(async()=>{var t,n,o,a,c;if(d&&l){O(!0),g(null);try{const r=await _.getSOSChatById(d);L(!1),N(Array.isArray(r==null?void 0:r.messages)?r.messages:[]),B(!!(r!=null&&r.read_only)),K(((t=r==null?void 0:r.chat)==null?void 0:t.security_name)||((n=r==null?void 0:r.chat)==null?void 0:n.security_email));const u=F();if(u)if(u.connected)u.emit("join_sos_chat",d);else{const m=()=>{u.emit("join_sos_chat",d),u.off("connect",m)};u.on("connect",m)}}catch(r){if(((o=r==null?void 0:r.response)==null?void 0:o.status)===403){L(!0);return}const m=((c=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:c.error)||(r==null?void 0:r.message)||"Failed to load chat";g(m)}finally{O(!1)}}},[d,l]),Y=i.useCallback(async()=>{if(d)try{const t=await _.getSOSById(d);j(t)}catch(t){console.error("Failed to load alert:",t)}finally{de(!1)}},[d]);i.useEffect(()=>{W.current=(s==null?void 0:s.user_id)||null},[s==null?void 0:s.user_id]),i.useEffect(()=>{if(!d)return;Y();const t=localStorage.getItem("accessToken");if(t){const n=he(t);return n.emit("join_sos",d),n.on("live_feed",o=>{ie(a=>{const c=W.current;return c&&(o!=null&&o.userId)&&o.userId!==c?a:[...a.slice(-50),o]})}),n.on("sos_status_update",o=>{o.id===d&&j(a=>a?{...a,...o,attachment_urls:(o==null?void 0:o.attachment_urls)??(a==null?void 0:a.attachment_urls)}:o)}),n.on("sos-updated",o=>{o.id===d&&j(a=>a?{...a,...o,attachment_urls:(o==null?void 0:o.attachment_urls)??(a==null?void 0:a.attachment_urls)}:o)}),()=>{n.off("live_feed"),n.off("sos_status_update"),n.off("sos-updated"),n.emit("leave_sos",d)}}},[d,Y]),i.useEffect(()=>{const t=s==null?void 0:s.attachment_urls;if(!s||!Array.isArray(t)){U([]);return}U(t)},[s]),i.useEffect(()=>{if(d&&l)return L(!1),N([]),K(void 0),h(),()=>{const t=F();t&&t.connected&&t.emit("leave_sos_chat",d)}},[d,h,l]),i.useEffect(()=>{d&&l&&l.role==="security"&&(s==null?void 0:s.status)==="acknowledged"&&(!f&&y||h())},[s==null?void 0:s.status,f,y,d,h,l]),i.useEffect(()=>{(s==null?void 0:s.status)==="resolved"&&B(!0)},[s==null?void 0:s.status]),i.useEffect(()=>{if(!d)return;const t=F();if(!t)return;const n=a=>{!a||String(a.sos_id)!==String(d)||N(c=>c.some(r=>r.id===a.id)?c:[...c,a])},o=a=>{!a||String(a.sosId)!==String(d)||g(a.error||"Failed to send message")};return t.on("chat:message",n),t.on("chat:error",o),()=>{t.off("chat:message",n),t.off("chat:error",o)}},[d]);const G=async()=>{var n,o;if(!d)return;const t=E.trim();if(t&&!(b||(s==null?void 0:s.status)==="resolved")){g(null);try{const a=await _.sendSOSChatMessage(d,t);N(c=>c.some(r=>r.id===a.id)?c:[...c,a]),P(""),await h()}catch(a){const c=((o=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:o.error)||(a==null?void 0:a.message)||"Failed to send message";g(c)}}},X=async t=>{var n,o,a,c;if(d){if((l==null?void 0:l.role)!=="security"){const r=document.createElement("div");r.className="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50",r.textContent="Only security personnel can update status",document.body.appendChild(r),setTimeout(()=>{r.remove()},3e3);return}try{M(!0);const r=await _.updateStatus(d,t);j(p=>p?{...p,...r,attachment_urls:(r==null?void 0:r.attachment_urls)??(p==null?void 0:p.attachment_urls)}:r),t==="acknowledged"&&await h();const u=t==="acknowledged"?"Alert acknowledged successfully":"Alert marked as resolved",m=document.createElement("div");m.className="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50",m.textContent=u,document.body.appendChild(m),setTimeout(()=>{m.remove()},3e3)}catch(r){console.error("Failed to update status:",r);const u=((o=(n=r==null?void 0:r.response)==null?void 0:n.data)==null?void 0:o.error)||((c=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:c.message)||(r==null?void 0:r.message)||"Failed to update status",m=document.createElement("div");m.className="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50",m.textContent=u,document.body.appendChild(m),setTimeout(()=>{m.remove()},3e3)}finally{M(!1)}}};if(ne)return e.jsxs("div",{className:"min-h-screen aurora-gradient flex items-center justify-center relative",children:[e.jsx("div",{className:"aurora-bg"}),e.jsx("div",{className:"glass-panel p-6 text-muted-foreground relative z-10",children:"Loading..."})]});if(!s)return e.jsxs("div",{className:"min-h-screen aurora-gradient flex items-center justify-center relative",children:[e.jsx("div",{className:"aurora-bg"}),e.jsx("div",{className:"glass-panel p-6 text-muted-foreground relative z-10",children:"Alert not found"})]});const le=x.map((t,n)=>{var o,a;return{time:n,risk:t.totalRisk,audio:((o=t.audio)==null?void 0:o.stress)*35||0,motion:((a=t.motion)==null?void 0:a.intensity)*25||0}}),v=(q=s.location)==null?void 0:q.lat,k=(H=s.location)==null?void 0:H.lng,w=typeof v=="number"?v:typeof v=="string"?Number.parseFloat(v):void 0,S=typeof k=="number"?k:typeof k=="string"?Number.parseFloat(k):void 0,V=typeof w=="number"&&Number.isFinite(w)&&typeof S=="number"&&Number.isFinite(S);return e.jsxs("div",{className:"min-h-screen bg-black p-6 relative",children:[e.jsx("div",{className:"aurora-bg"}),e.jsxs("div",{className:"max-w-7xl mx-auto relative z-10",children:[e.jsxs("div",{className:"glass-panel border-b border-border/50 px-6 py-4 flex justify-between items-center mb-8",children:[e.jsx(xe,{to:"/security",className:"text-aurora-cyan hover:opacity-80 transition-opacity",children:"← Back to Alerts"}),e.jsx("button",{onClick:()=>oe("/security"),className:"px-4 py-2 bg-secondary/60 hover:bg-secondary/80 text-foreground rounded-lg transition-colors border border-border/50",children:"Close"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"glass-panel p-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-foreground mb-2",children:["Risk Score: ",s.risk_score.toFixed(1)]}),e.jsxs("p",{className:"text-muted-foreground",children:["User: ",s.name||s.email||s.user_id]}),e.jsx("p",{className:"text-muted-foreground",children:new Date(s.created_at).toLocaleString()})]}),e.jsx("span",{className:`px-4 py-2 rounded font-semibold ${s.status==="resolved"?"bg-safe/20 text-safe":s.status==="acknowledged"?"bg-warning/20 text-warning":"bg-danger/20 text-danger"}`,children:s.status.toUpperCase()})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-6",children:[e.jsxs("div",{className:"bg-secondary/40 border border-border/40 rounded p-4",children:[e.jsx("div",{className:"text-muted-foreground text-sm mb-1",children:"Audio Stress"}),e.jsx("div",{className:"text-2xl font-bold text-foreground",children:s.factors.audio.toFixed(1)})]}),e.jsxs("div",{className:"bg-secondary/40 border border-border/40 rounded p-4",children:[e.jsx("div",{className:"text-muted-foreground text-sm mb-1",children:"Motion Intensity"}),e.jsx("div",{className:"text-2xl font-bold text-foreground",children:s.factors.motion.toFixed(1)})]}),e.jsxs("div",{className:"bg-secondary/40 border border-border/40 rounded p-4",children:[e.jsx("div",{className:"text-muted-foreground text-sm mb-1",children:"Time Risk"}),e.jsx("div",{className:"text-2xl font-bold text-foreground",children:s.factors.time.toFixed(1)})]}),e.jsxs("div",{className:"bg-secondary/40 border border-border/40 rounded p-4",children:[e.jsx("div",{className:"text-muted-foreground text-sm mb-1",children:"Location Risk"}),e.jsx("div",{className:"text-2xl font-bold text-foreground",children:s.factors.location.toFixed(1)})]})]}),s.status!=="resolved"&&e.jsxs("div",{className:"mt-6 flex gap-4",children:[s.status==="new"&&e.jsx("button",{onClick:()=>X("acknowledged"),disabled:I||(l==null?void 0:l.role)!=="security",className:"px-6 py-2 bg-warning hover:bg-yellow-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Acknowledge"}),e.jsx("button",{onClick:()=>X("resolved"),disabled:I||(l==null?void 0:l.role)!=="security",className:"px-6 py-2 bg-safe hover:bg-green-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Mark Resolved"})]})]}),C.length>0||D?e.jsxs("div",{className:"glass-panel p-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground",children:"Media Attachments"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:D?"Loading…":`${C.length} file(s)`})]}),T.length===0?e.jsxs("div",{className:"mt-4 text-sm text-muted-foreground",children:["Attachments were included, but a preview could not be generated. If this persists, add a Storage SELECT policy for bucket ",e.jsx("span",{className:"font-semibold",children:"sos-attachment"})," (authenticated users) so Security can create signed URLs."]}):e.jsx("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:T.map((t,n)=>{const o=C[n]||"",a=/\.(mp4|webm|mov|m4v|ogg)(\?|$)/i.test(o);return e.jsxs("div",{className:"rounded-xl border border-border/40 bg-secondary/30 overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 border-b border-border/40",children:e.jsx("div",{className:"text-sm font-semibold text-foreground truncate",children:o||`Attachment ${n+1}`})}),e.jsx("div",{className:"p-3",children:a?e.jsx("video",{src:t,controls:!0,className:"w-full max-h-[360px] rounded-lg bg-black"}):e.jsx("img",{src:t,alt:"Attachment",className:"w-full max-h-[360px] object-contain rounded-lg bg-black/20"})})]},t)})})]}):null,x.length>0&&e.jsxs("div",{className:"glass-panel p-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground mb-4",children:"Live Risk Timeline"}),e.jsx(be,{width:"100%",height:300,children:e.jsxs(pe,{data:le,children:[e.jsx(je,{strokeDasharray:"3 3",stroke:"#475569"}),e.jsx(ye,{dataKey:"time",stroke:"#94a3b8"}),e.jsx(Ne,{stroke:"#94a3b8"}),e.jsx(ve,{contentStyle:{backgroundColor:"rgba(15, 23, 42, 0.9)",border:"1px solid rgba(148, 163, 184, 0.2)"}}),e.jsx(R,{type:"monotone",dataKey:"risk",stroke:"#ef4444",strokeWidth:2}),e.jsx(R,{type:"monotone",dataKey:"audio",stroke:"#f59e0b",strokeWidth:1}),e.jsx(R,{type:"monotone",dataKey:"motion",stroke:"#10b981",strokeWidth:1})]})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"map-container p-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground mb-4",children:"Location"}),e.jsx("div",{className:"text-muted-foreground mb-4",children:V?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:["Latitude: ",w]}),e.jsxs("div",{children:["Longitude: ",S]})]}):e.jsx("div",{children:"No coordinates available"})}),e.jsx(ge,{sosMarkers:V?[{id:s.id,lat:w,lng:S,riskScore:s.risk_score}]:[],height:"300px",enableGeolocation:!1})]}),e.jsxs("div",{className:"glass-panel p-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground mb-4",children:"Event Timeline"}),e.jsx(fe,{sosId:s.id,sosEvent:s})]}),e.jsxs("div",{className:"glass-panel p-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4 pb-3 border-b border-border/40",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground",children:"Chat"}),e.jsx("div",{className:"mt-1 text-sm text-muted-foreground",children:y?`Responder: ${y}`:"Responder: (unassigned)"})]}),e.jsx("div",{className:"text-xs text-muted-foreground px-2 py-1 rounded-md border border-border/40 bg-black/30",children:b||s.status==="resolved"?"Read-only":"Live"})]}),A?e.jsx("div",{className:"text-center py-6 text-muted-foreground",children:"Loading chat…"}):f?e.jsx("div",{className:"mt-3 text-sm text-muted-foreground",children:"Only the assigned security responder can access this chat."}):z?e.jsx("div",{className:"mt-3 text-sm text-danger",children:z}):null,e.jsx("div",{className:"mt-4 rounded-lg border border-border/50 bg-black/35 h-[260px] overflow-y-auto p-4",children:$.length===0?e.jsx("div",{className:"text-muted-foreground text-sm",children:"No messages yet."}):e.jsx("div",{className:"space-y-3",children:$.map(t=>{const n=!!(l!=null&&l.id&&t.sender_id===l.id);return e.jsx("div",{className:n?"flex justify-end":"flex justify-start",children:e.jsxs("div",{className:n?"max-w-[85%] rounded-2xl rounded-tr-sm bg-primary/20 border border-primary/25 px-4 py-3 shadow-[0_10px_30px_rgba(0,0,0,0.35)]":"max-w-[85%] rounded-2xl rounded-tl-sm bg-secondary/35 border border-border/50 px-4 py-3",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:[n?"You":t.sender_name||t.sender_email||t.sender_id," • ",new Date(t.created_at).toLocaleString()]}),e.jsx("div",{className:"text-foreground mt-1 whitespace-pre-wrap",children:t.message})]})},t.id)})})}),e.jsxs("div",{className:"mt-4 flex gap-3",children:[e.jsx("input",{value:E,onChange:t=>P(t.target.value),placeholder:b||s.status==="resolved"?"Chat is read-only (resolved)":"Type a message…",disabled:f||A||b||s.status==="resolved",className:"flex-1 px-4 py-3 rounded-xl border border-border/60 bg-black/30 text-foreground backdrop-blur-sm focus:outline-none focus:border-primary/60 disabled:opacity-60",onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),G())}}),e.jsx("button",{type:"button",onClick:G,disabled:f||A||b||s.status==="resolved"||!E.trim(),className:"px-5 py-3 bg-primary/80 hover:bg-primary text-primary-foreground rounded-xl border border-primary/30 shadow-[0_0_24px_rgba(37,246,228,0.15)] disabled:opacity-50 disabled:cursor-not-allowed",children:"Send"})]})]}),x.length>0&&e.jsxs("div",{className:"glass-panel p-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground mb-4",children:"Live Feed"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-sm mb-1",children:"Current Risk"}),e.jsx("div",{className:"text-2xl font-bold text-foreground",children:((Q=(J=x[x.length-1])==null?void 0:J.totalRisk)==null?void 0:Q.toFixed(1))||"N/A"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-sm mb-1",children:"Audio RMS"}),e.jsx("div",{className:"text-lg text-foreground",children:((se=(ee=(Z=x[x.length-1])==null?void 0:Z.audio)==null?void 0:ee.rms)==null?void 0:se.toFixed(2))||"N/A"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-sm mb-1",children:"Motion"}),e.jsx("div",{className:"text-lg text-foreground",children:((ae=(re=(te=x[x.length-1])==null?void 0:te.motion)==null?void 0:re.acceleration)==null?void 0:ae.toFixed(2))||"N/A"})]})]})]})]})]})]})]})}export{Ee as default};
